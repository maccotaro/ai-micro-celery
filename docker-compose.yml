version: '3.8'

services:
  celery-worker:
    build: .
    container_name: ai-micro-celery-worker
    command: celery -A app.core.celery_app worker --loglevel=info --pool=threads --concurrency=4
    environment:
      # Database
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-password}@host.docker.internal:5432/admindb

      # Celery
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-cfb4602f86707acf2a264bac18456bdafb4c9acd11e6cc1d89f606d1e2dc679f}@host.docker.internal:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-cfb4602f86707acf2a264bac18456bdafb4c9acd11e6cc1d89f606d1e2dc679f}@host.docker.internal:6379/2

      # Ollama (Embedding生成用)
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_CHAT_MODEL=gemma2:9b
      - EMBEDDING_MODEL=bge-m3:567m

      # Neo4j (GraphRAG)
      - NEO4J_URI=bolt://host.docker.internal:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-e03ac48d4e1264ead1a0106faff45e8f}

      # GPU環境用の環境変数（ai-micro-api-adminと同様）
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_HOME=/usr/local/cuda
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib:/usr/local/cuda/lib64:/usr/local/nvidia/lib:/usr/local/nvidia/lib64

      # Environment
      - PYTHONPATH=/app
    volumes:
      # ai-micro-api-admin のコードを共有
      - ../ai-micro-api-admin/app:/app/app:ro
      # アップロードファイルへのアクセス（Docling処理用）
      - ../ai-micro-api-admin/uploads:/app/uploads:ro
      # ドキュメント処理画像の共有ボリューム
      - document_processing:/tmp/document_processing
    deploy:
      resources:
        limits:
          memory: 12G
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    mem_swappiness: 0
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - ai-micro-network
    healthcheck:
      test: ["CMD", "/app/healthcheck.sh"]
      interval: 30s
      timeout: 20s
      retries: 3

  celery-beat:
    build: .
    container_name: ai-micro-celery-beat
    command: celery -A app.core.celery_app beat --loglevel=info
    environment:
      # Database
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-password}@host.docker.internal:5432/admindb

      # Celery
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-cfb4602f86707acf2a264bac18456bdafb4c9acd11e6cc1d89f606d1e2dc679f}@host.docker.internal:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD:-cfb4602f86707acf2a264bac18456bdafb4c9acd11e6cc1d89f606d1e2dc679f}@host.docker.internal:6379/2

      # Ollama
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_CHAT_MODEL=gemma2:9b
      - EMBEDDING_MODEL=bge-m3:567m

      # Neo4j (GraphRAG)
      - NEO4J_URI=bolt://host.docker.internal:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-e03ac48d4e1264ead1a0106faff45e8f}

      # Environment
      - PYTHONPATH=/app
    volumes:
      - ../ai-micro-api-admin/app:/app/app:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - ai-micro-network
    depends_on:
      - celery-worker

networks:
  ai-micro-network:
    external: true

volumes:
  document_processing:
    driver: local
